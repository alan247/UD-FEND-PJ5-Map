var viewModel=function(){var a=this;a.wikiArticles=ko.observableArray(),a.flickrPics=ko.observableArray(),a.filter=ko.observable(""),a.currentCityCountry=ko.observable(""),a.currentCity=ko.observable(""),a.currentLocationData=ko.observable(""),a.markersFinalArray=ko.observableArray([]);var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(40.8333467,-48.1009912),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControl:!1}),r=new google.maps.Geocoder;new google.maps.places.Autocomplete(document.getElementById("pac-input"),{bounds:new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),types:["(cities)"]});a.geocodeInput=function(){var e=$("#pac-input").val();r.geocode({address:e},function(e,r){if(r==google.maps.GeocoderStatus.OK){t.setCenter(e[0].geometry.location);var i=e[0].formatted_address,n=e[0].geometry.location.lat(),l=e[0].geometry.location.lng();new o(i,n,l,!0),a.storeLocally()}else alert("Geocode was not successful for the following reason: "+r)})},a.storeLocally=function(){var e=a.markersFinalArray(),t=[];$.each(e,function(e,a){markerObject={name:a.name,lat:a.lat,"long":a["long"],userCreated:a.userCreated},t.push(markerObject)}),localStorage.setItem("userLocalData",JSON.stringify(t))},$("#pac-input").keyup(function(e){13==e.keyCode&&($("#add-overlay").hide(),a.geocodeInput())});var o=function(e,r,o,i){a.markersFinalArray.push({marker:new google.maps.Marker({position:new google.maps.LatLng(r,o),title:e,animation:google.maps.Animation.DROP,map:t,icon:i?"http://maps.google.com/mapfiles/ms/micons/blue.png":"http://maps.google.com/mapfiles/ms/micons/red.png"}),name:e,lat:r,"long":o,userCreated:i});var n=a.markersFinalArray().length,l=a.markersFinalArray()[n-1],s=l.marker,c=l.name,m=l.lat,u=l["long"];s.addListener("click",function(){a.clickOnItem(c,s,m,u,i)})};if(a.deleteMarker=function(e){var t=e.name,r=a.markersFinalArray;for(var o in r())t===r()[o].name&&(r()[o].marker.setMap(null),r().splice(o,1),r(r()),a.storeLocally())},null!==localStorage.getItem("userLocalData")){var i=JSON.parse(localStorage.getItem("userLocalData"));$.each(i,function(e,a){var t=a.lat,r=a["long"],i=a.name,n=a.userCreated;new o(i,t,r,n)})}else{var n="http://paperbac.pairserver.com/locations.php";$.getJSON(n,function(e){var a=e.locations;$.each(a,function(e,a){var t=a.city+", "+a.country,r=a.latitude,i=a.longitude;new o(t,r,i,!1)})}).fail(function(){alert("Could not load sample markers from the server, but feel free to add your own!")})}a.clickOnItem=function(e,r,o,i,n){$(".list-container ul li").each(function(){var a=$(this).children(".list-item").html();e===a&&$(this).addClass("selected").siblings().removeClass("selected")}),a.changeIcons();var l=e.split(",");a.currentCity(l[0]),a.currentCityCountry(e),a.currentLocationData(e+"|"+n),$("#location-info").show();var s,c="http://maps.google.com/mapfiles/kml/paddle/blu-stars.png",m="http://maps.google.com/mapfiles/kml/paddle/red-stars.png";s=n?c:m,r.setIcon(s),r.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){r.setAnimation(null)},750);var u=new google.maps.LatLng(o,i);t.panTo(u),t.setZoom(5);var p=$(window).width();if($(window).width()<=1024)t.panBy(0,-210);else{var g=.5*p/2;t.panBy(-g,-210)}a.getWikiData(o,i),a.getFlickrData(o,i,e),null!=$("#flickr-gallery").data("lightGallery")&&$("#flickr-gallery").data("lightGallery").destroy(!0)},a.goToMarker=function(e){var t=e.name,r=a.markersFinalArray();for(var o in r)if(t===r[o].name){var i=r[o].marker,n=r[o].lat,l=r[o]["long"],s=r[o].userCreated;a.clickOnItem(t,i,n,l,s)}},a.clearFilter=function(){a.filter("")},$("#locations-filter").is(":focus")&&27==e.keyCode&&a.clearFilter(),a.changeIcons=function(){var e=a.currentLocationData().split("|"),t=e[0],r=e[1],o=a.markersFinalArray();for(var i in o)if(t===o[i].name){var n=o[i].marker;"true"===r?n.setIcon("http://maps.google.com/mapfiles/ms/micons/blue.png"):n.setIcon("http://maps.google.com/mapfiles/ms/micons/red.png")}},a.filteredItems=ko.computed(function(){var e=a.filter().toLowerCase();if(e)return ko.utils.arrayFilter(a.markersFinalArray(),function(t){for(var r in a.markersFinalArray()){var o=a.markersFinalArray()[r].name.toLowerCase();o.search(e)>=0?a.markersFinalArray()[r].marker.setVisible(!0):a.markersFinalArray()[r].marker.setVisible(!1)}return t.name.toLowerCase().search(e)>=0});for(var t=0;t<a.markersFinalArray().length;t++)a.markersFinalArray()[t].marker.setVisible(!0);return a.markersFinalArray()}),a.getWikiData=function(e,t){a.wikiArticles().length=0;var r=e+"|"+t,o="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages%7Cinfo&list=&generator=geosearch&piprop=thumbnail&pithumbsize=80&pilimit=4&inprop=url&ggscoord="+r+"&ggsradius=10000&ggslimit=4&callback=?";$.getJSON(o,function(e){var t=e.query.pages;$.each(t,function(e,t){var r=t.title,o=t.fullurl;if("thumbnail"in t)var i=t.thumbnail.source,n=t.thumbnail.width,l=t.thumbnail.height;else var i="img/nopicture.gif";var s={title:r,thumbnail:i,thumbnailWidth:n,thumbnailHeight:l,url:o};a.wikiArticles.push(s)})}).fail(function(){$(".api-card.wikipedia").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach Wikipedia, try again later!</div>')})},a.getFlickrData=function(e,t,r){$("#flickr-load").show(),$("#flickr-gallery").hide(),a.flickrPics().length=0;var o=encodeURIComponent(r.split(",")[0].trim()),i="3a36e9a73746f67a89753089747aede3",n="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+i+"&format=json&nojsoncallback=1&per_page=10&tags="+o+",tourist&tag_mode=all";$.getJSON(n,function(e){var t=e.photos.photo;$.each(t,function(e,t){var r=t.farm,o=t.server,i=t.id,n=t.secret,l=(t.owner,t.title),s="http://farm"+r+".static.flickr.com/"+o+"/"+i+"_"+n+".jpg",c="http://farm"+r+".static.flickr.com/"+o+"/"+i+"_"+n+"_t.jpg",m={src:s,thumb:c,subHtml:l};a.flickrPics.push(m)})}).fail(function(){$(".api-card.flickr").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach flickr, try again later!</div>')}).always(function(){$("#flickr-load").fadeOut(500),$("#flickr-gallery").delay(500).fadeIn(500),$("#flickr-gallery").lightGallery()})},function(e){function a(a,r){if("keydown"==a){var o=r;r=function(a){var t=$(".pac-item-selected").length>0;if(13==a.which&&!t){var r=$.Event("keydown",{keyCode:40,which:40});o.apply(e,[r])}o.apply(e,[a])}}t.apply(e,[a,r])}var t=e.addEventListener?e.addEventListener:e.attachEvent;e.addEventListener?e.addEventListener=a:e.attachEvent&&(e.attachEvent=a)}($("#pac-input")[0])};ko.applyBindings(new viewModel);var itemsList=$("#locations-list"),showListButton=$("#show-list-button"),closeItemsList=function(){$(window).width()<=1024?itemsList.css("left","-100vw"):(itemsList.css("left","-25vw"),showListButton.find("i").html("keyboard_arrow_right"))},showItemsList=function(){itemsList.css("left","0"),$(window).width()<=1024?showListButton.fadeOut():showListButton.find("i").html("keyboard_arrow_left")};$("#locations-filter").on("focus keydown",function(){showItemsList()}),$("#show-list-button").on("click",function(){"0px"===itemsList.css("left")?closeItemsList():showItemsList()}),$("#go-back-bar").on("click",function(){$("#locations-list").css("left","-100vw"),$("#show-list-button").fadeIn()});var openAddItem=function(){$("#add-overlay").show(),$("#pac-input").val("").focus(),$("#overlay-close-button").on("click",function(){$(this).parent().hide()})};$("#add-button").on("click",function(){openAddItem()}),$("#location-header i").on("click",function(){$("#location-info, #wikipedia-list").fadeOut()});