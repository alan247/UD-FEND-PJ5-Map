function googleSuccess(){ko.applyBindings(new viewModel)}function googleError(){$("body").html('<div class="gmaps-error">Google Maps couldn\'t be loaded :/</div>')}var viewModel=function(){"use strict";var t=this;t.wikiArticles=ko.observableArray(),t.flickrPics=ko.observableArray(),t.filter=ko.observable(""),t.currentCityCountry=ko.observable(""),t.currentCity=ko.observable(""),t.currentLocationData=ko.observable(""),t.markersFinalArray=ko.observableArray([]),t.pacInput=ko.observable("").extend({notify:"always"});var a=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(40.8333467,-48.1009912),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}}),o=new google.maps.Geocoder;ko.bindingHandlers.autoComplete={init:function(e,t){var a=new google.maps.places.Autocomplete(e,{bounds:new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),types:["(cities)"]}),o=t();google.maps.event.addListener(a,"place_changed",function(){var e=a.getPlace();o(e.formatted_address)})},update:function(e,a){ko.bindingHandlers.value.update(e,a),t.addKeyListener=function(e,a){13==a.keyCode&&(console.log("KL: "+t.pacInput()),$("#add-overlay").hide(),setTimeout(function(){t.geocodeInput()},750))}}},t.geocodeInput=function(){o.geocode({address:t.pacInput()},function(e,o){if(o==google.maps.GeocoderStatus.OK){a.setCenter(e[0].geometry.location);var i=e[0].formatted_address,n=e[0].geometry.location.lat(),l=e[0].geometry.location.lng();new r(i,n,l,!0),t.storeLocally()}else alert("Geocode was not successful for the following reason: "+o)})},t.storeLocally=function(){var e=t.markersFinalArray(),a=[];$.each(e,function(e,t){var o={name:t.name,lat:t.lat,"long":t["long"],userCreated:t.userCreated};a.push(o)}),localStorage.setItem("userLocalData",JSON.stringify(a))};var r=function(e,o,r,i){t.markersFinalArray.push({marker:new google.maps.Marker({position:new google.maps.LatLng(o,r),title:e,animation:google.maps.Animation.DROP,map:a,icon:i?"http://maps.google.com/mapfiles/ms/micons/blue.png":"http://maps.google.com/mapfiles/ms/micons/red.png"}),name:e,lat:o,"long":r,userCreated:i});var n=t.markersFinalArray().length,l=t.markersFinalArray()[n-1],s=l.marker,c=l.name,m=l.lat,u=l["long"];s.addListener("click",function(){t.clickOnItem(c,s,m,u,i)})};if(t.deleteMarker=function(e){var a=e.name,o=t.markersFinalArray;for(var r in o())a===o()[r].name&&(o()[r].marker.setMap(null),o().splice(r,1),o(o()),t.storeLocally())},null!==localStorage.getItem("userLocalData")){var i=JSON.parse(localStorage.getItem("userLocalData"));$.each(i,function(e,t){var a=t.lat,o=t["long"],i=t.name,n=t.userCreated;new r(i,a,o,n)})}else{var n="http://paperbac.pairserver.com/locations.php";$.getJSON(n,function(e){var t=e.locations;$.each(t,function(e,t){var a=t.city+", "+t.country,o=t.latitude,i=t.longitude;new r(a,o,i,!1)})}).fail(function(){alert("Could not load sample markers from the server, but feel free to add your own!")})}t.clickOnItem=function(e,o,r,i,n){$(".list-container ul li").each(function(){var t=$(this).children(".list-item").html();e===t&&$(this).addClass("selected").siblings().removeClass("selected")}),t.changeIcons();var l=e.split(",");t.currentCity(l[0]),t.currentCityCountry(e),t.currentLocationData(e+"|"+n),$("#location-info").show(),$(window).width()<=1024&&$("#locations-list").css("left","0");var s,c="http://maps.google.com/mapfiles/kml/paddle/blu-stars.png",m="http://maps.google.com/mapfiles/kml/paddle/red-stars.png";s=n?c:m,o.setIcon(s),o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},750);var u=new google.maps.LatLng(r,i);a.panTo(u),a.setZoom(5);var d=$(window).width();if($(window).width()<=1024)a.panBy(0,-210);else{var p=.5*d/2;a.panBy(-p,-210)}t.getWikiData(r,i),t.getFlickrData(r,i,e),null!==$("#flickr-gallery").data("lightGallery")&&$("#flickr-gallery").data("lightGallery").destroy(!0)},t.goToMarker=function(e){var a=e.name,o=t.markersFinalArray();for(var r in o)if(a===o[r].name){var i=o[r].marker,n=o[r].lat,l=o[r]["long"],s=o[r].userCreated;t.clickOnItem(a,i,n,l,s)}},t.clearFilter=function(){t.filter("")},$("#locations-filter").is(":focus")&&27==e.keyCode&&t.clearFilter(),t.changeIcons=function(){var e=t.currentLocationData().split("|"),a=e[0],o=e[1],r=t.markersFinalArray();for(var i in r)if(a===r[i].name){var n=r[i].marker;"true"===o?n.setIcon("http://maps.google.com/mapfiles/ms/micons/blue.png"):n.setIcon("http://maps.google.com/mapfiles/ms/micons/red.png")}},t.filteredItems=ko.computed(function(){var e=t.filter().toLowerCase();if(e)return ko.utils.arrayFilter(t.markersFinalArray(),function(a){for(var o in t.markersFinalArray()){var r=t.markersFinalArray()[o].name.toLowerCase();r.search(e)>=0?t.markersFinalArray()[o].marker.setVisible(!0):t.markersFinalArray()[o].marker.setVisible(!1)}return a.name.toLowerCase().search(e)>=0});for(var a=0;a<t.markersFinalArray().length;a++)t.markersFinalArray()[a].marker.setVisible(!0);return t.markersFinalArray()}),t.getWikiData=function(e,a){t.wikiArticles().length=0;var o=e+"|"+a,r="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages%7Cinfo&list=&generator=geosearch&piprop=thumbnail&pithumbsize=80&pilimit=4&inprop=url&ggscoord="+o+"&ggsradius=10000&ggslimit=4&callback=?";$.getJSON(r,function(e){var a,o,r,i=e.query.pages;$.each(i,function(e,i){var n=i.title,l=i.fullurl;"thumbnail"in i?(a=i.thumbnail.source,o=i.thumbnail.width,r=i.thumbnail.height):a="img/nopicture.gif";var s={title:n,thumbnail:a,thumbnailWidth:o,thumbnailHeight:r,url:l};t.wikiArticles.push(s)})}).fail(function(){$(".api-card.wikipedia").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach Wikipedia, try again later!</div>')})},t.getFlickrData=function(e,a,o){$("#flickr-load").show(),$("#flickr-gallery").hide(),t.flickrPics().length=0;var r=encodeURIComponent(o.split(",")[0].trim()),i="3a36e9a73746f67a89753089747aede3",n="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+i+"&format=json&nojsoncallback=1&per_page=10&tags="+r+",tourist&tag_mode=all";$.getJSON(n,function(e){var a=e.photos.photo;$.each(a,function(e,a){var o=a.farm,r=a.server,i=a.id,n=a.secret,l=a.title,s="http://farm"+o+".static.flickr.com/"+r+"/"+i+"_"+n+".jpg",c="http://farm"+o+".static.flickr.com/"+r+"/"+i+"_"+n+"_t.jpg",m={src:s,thumb:c,subHtml:l};t.flickrPics.push(m)})}).fail(function(){$(".api-card.flickr").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach flickr, try again later!</div>')}).always(function(){$("#flickr-load").fadeOut(500),$("#flickr-gallery").delay(500).fadeIn(500),$("#flickr-gallery").lightGallery()})},function(e){function t(t,o){if("keydown"==t){var r=o;o=function(t){var a=$(".pac-item-selected").length>0;if(13==t.which&&!a){var o=$.Event("keydown",{keyCode:40,which:40});r.apply(e,[o])}r.apply(e,[t])}}a.apply(e,[t,o])}var a=e.addEventListener?e.addEventListener:e.attachEvent;e.addEventListener?e.addEventListener=t:e.attachEvent&&(e.attachEvent=t)}($("#pac-input")[0])},itemsList=$("#locations-list"),showListButton=$("#show-list-button"),closeItemsList=function(){$(window).width()<=1024?itemsList.css("left","-100vw"):(itemsList.css("left","-25vw"),showListButton.find("i").html("keyboard_arrow_right"))},showItemsList=function(){itemsList.css("left","0"),$(window).width()<=1024?showListButton.fadeOut():showListButton.find("i").html("keyboard_arrow_left")};$("#locations-filter").on("focus keydown",function(){showItemsList()}),$("#show-list-button").on("click",function(){"0px"===itemsList.css("left")?closeItemsList():showItemsList()}),$("#go-back-bar").on("click",function(){$("#locations-list").css("left","-100vw"),$("#show-list-button").fadeIn()});var openAddItem=function(){$("#add-overlay").show(),$("#pac-input").val("").focus(),$("#overlay-close-button").on("click",function(){$(this).parent().hide()})};$("#add-button").on("click",function(){openAddItem()}),$("#location-header i").on("click",function(){$("#location-info, #wikipedia-list").fadeOut()});