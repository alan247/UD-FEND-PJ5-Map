function googleSuccess(){ko.applyBindings(new viewModel)}function googleError(){$("body").html('<div class="gmaps-error">Google Maps couldn\'t be loaded :/</div>')}var viewModel=function(){"use strict";var a=this;a.wikiArticles=ko.observableArray(),a.flickrPics=ko.observableArray(),a.filter=ko.observable(""),a.currentCityCountry=ko.observable(""),a.currentCity=ko.observable(""),a.currentLocationData=ko.observable(""),a.markersFinalArray=ko.observableArray([]),a.pacInput=ko.observable("").extend({notify:"always"}),a.infoVisible=ko.observable(!1),a.listVisible=ko.observable(!1),a.addOverlayVisible=ko.observable(!1),a.addInputFocus=ko.observable(!1),a.arrowButton=ko.observable("keyboard_arrow_right"),a.filterFocus=ko.observable(!1);var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(40.8333467,-48.1009912),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}}),o=new google.maps.Geocoder;ko.bindingHandlers.autoComplete={init:function(e,a){var t=new google.maps.places.Autocomplete(e,{bounds:new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),types:["(cities)"]}),o=a();google.maps.event.addListener(t,"place_changed",function(){var e=t.getPlace();o(e.formatted_address)})},update:function(e,a){ko.bindingHandlers.value.update(e,a)}},a.showAddOverlay=function(){a.addOverlayVisible(!0),a.addInputFocus(!0)},a.hideAddOverlay=function(){a.addOverlayVisible(!1)},a.addKeyListener=function(e,t){13==t.keyCode&&(a.hideAddOverlay(),setTimeout(function(){a.geocodeInput()},1250))},a.geocodeInput=function(){o.geocode({address:a.pacInput()},function(e,o){if(o==google.maps.GeocoderStatus.OK){t.setCenter(e[0].geometry.location);var i=e[0].formatted_address,n=e[0].geometry.location.lat(),l=e[0].geometry.location.lng();new r(i,n,l,!0),a.storeLocally()}else alert("Geocode was not successful for the following reason: "+o)})},a.storeLocally=function(){var e=a.markersFinalArray(),t=[];$.each(e,function(e,a){var o={name:a.name,lat:a.lat,"long":a["long"],userCreated:a.userCreated};t.push(o)}),localStorage.setItem("userLocalData",JSON.stringify(t))};var r=function(e,o,r,i){a.markersFinalArray.push({marker:new google.maps.Marker({position:new google.maps.LatLng(o,r),title:e,animation:google.maps.Animation.DROP,map:t,icon:i?"http://maps.google.com/mapfiles/ms/micons/blue.png":"http://maps.google.com/mapfiles/ms/micons/red.png"}),name:e,lat:o,"long":r,userCreated:i});var n=a.markersFinalArray().length,l=a.markersFinalArray()[n-1],s=l.marker,c=l.name,m=l.lat,u=l["long"];s.addListener("click",function(){a.clickOnItem(c,s,m,u,i)})};if(a.deleteMarker=function(e){var t=e.name,o=a.markersFinalArray;for(var r in o())t===o()[r].name&&(o()[r].marker.setMap(null),o().splice(r,1),o(o()),a.storeLocally())},null!==localStorage.getItem("userLocalData")){var i=JSON.parse(localStorage.getItem("userLocalData"));$.each(i,function(e,a){var t=a.lat,o=a["long"],i=a.name,n=a.userCreated;new r(i,t,o,n)})}else{var n="http://paperbac.pairserver.com/locations.php";$.getJSON(n,function(e){var a=e.locations;$.each(a,function(e,a){var t=a.city+", "+a.country,o=a.latitude,i=a.longitude;new r(t,o,i,!1)})}).fail(function(){alert("Could not load sample markers from the server, but feel free to add your own!")})}a.clickOnItem=function(e,o,r,i,n){a.changeIcons();var l=e.split(",");a.currentCity(l[0]),a.currentCityCountry(e),a.currentLocationData(e+"|"+n),a.openInfoWindow();var s,c="http://maps.google.com/mapfiles/kml/paddle/blu-stars.png",m="http://maps.google.com/mapfiles/kml/paddle/red-stars.png";s=n?c:m,o.setIcon(s),o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},750);var u=new google.maps.LatLng(r,i);t.panTo(u),t.setZoom(5);var d=$(window).width();if($(window).width()<=1024)t.panBy(0,-210);else{var p=.5*d/2;t.panBy(-p,-210)}a.getWikiData(r,i),a.getFlickrData(r,i,e),void 0!==$("#flickr-gallery").data("lightGallery")&&$("#flickr-gallery").data("lightGallery").destroy(!0)},a.openInfoWindow=function(){a.infoVisible(!0),a.listVisible(!0),a.arrowButton("keyboard_arrow_left")},a.closeInfoWindow=function(){a.infoVisible(!1),a.listVisible(!1),a.arrowButton("keyboard_arrow_right")},a.goToMarker=function(e){var t=e.name,o=a.markersFinalArray();for(var r in o)if(t===o[r].name){var i=o[r].marker,n=o[r].lat,l=o[r]["long"],s=o[r].userCreated;a.clickOnItem(t,i,n,l,s)}},a.clearFilter=function(){a.filter("")},a.filterFocus()&&27==e.keyCode&&a.clearFilter(),a.changeIcons=function(){var e=a.currentLocationData().split("|"),t=e[0],o=e[1],r=a.markersFinalArray();for(var i in r)if(t===r[i].name){var n=r[i].marker;"true"===o?n.setIcon("http://maps.google.com/mapfiles/ms/micons/blue.png"):n.setIcon("http://maps.google.com/mapfiles/ms/micons/red.png")}},a.filteredItems=ko.computed(function(){var e=a.filter().toLowerCase();if(e)return ko.utils.arrayFilter(a.markersFinalArray(),function(t){for(var o in a.markersFinalArray()){var r=a.markersFinalArray()[o].name.toLowerCase();r.search(e)>=0?a.markersFinalArray()[o].marker.setVisible(!0):a.markersFinalArray()[o].marker.setVisible(!1)}return t.name.toLowerCase().search(e)>=0});for(var t=0;t<a.markersFinalArray().length;t++)a.markersFinalArray()[t].marker.setVisible(!0);return a.markersFinalArray()}),a.getWikiData=function(e,t){a.wikiArticles().length=0;var o=e+"|"+t,r="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages%7Cinfo&list=&generator=geosearch&piprop=thumbnail&pithumbsize=80&pilimit=4&inprop=url&ggscoord="+o+"&ggsradius=10000&ggslimit=4&callback=?";$.getJSON(r,function(e){var t,o,r,i=e.query.pages;$.each(i,function(e,i){var n=i.title,l=i.fullurl;"thumbnail"in i?(t=i.thumbnail.source,o=i.thumbnail.width,r=i.thumbnail.height):t="img/nopicture.gif";var s={title:n,thumbnail:t,thumbnailWidth:o,thumbnailHeight:r,url:l};a.wikiArticles.push(s)})}).fail(function(){$(".api-card.wikipedia").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach Wikipedia, try again later!</div>')})},a.getFlickrData=function(e,t,o){$("#flickr-load").show(),$("#flickr-gallery").hide(),a.flickrPics().length=0;var r=encodeURIComponent(o.split(",")[0].trim()),i="3a36e9a73746f67a89753089747aede3",n="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+i+"&format=json&nojsoncallback=1&per_page=10&tags="+r+",tourist&tag_mode=all";$.getJSON(n,function(e){var t=e.photos.photo;$.each(t,function(e,t){var o=t.farm,r=t.server,i=t.id,n=t.secret,l=t.title,s="http://farm"+o+".static.flickr.com/"+r+"/"+i+"_"+n+".jpg",c="http://farm"+o+".static.flickr.com/"+r+"/"+i+"_"+n+"_t.jpg",m={src:s,thumb:c,subHtml:l};a.flickrPics.push(m)})}).fail(function(){$(".api-card.flickr").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach flickr, try again later!</div>')}).always(function(){$("#flickr-load").fadeOut(500),$("#flickr-gallery").delay(500).fadeIn(500),$("#flickr-gallery").lightGallery()})},function(e){function a(a,o){if("keydown"==a){var r=o;o=function(a){var t=$(".pac-item-selected").length>0;if(13==a.which&&!t){var o=$.Event("keydown",{keyCode:40,which:40});r.apply(e,[o])}r.apply(e,[a])}}t.apply(e,[a,o])}var t=e.addEventListener?e.addEventListener:e.attachEvent;e.addEventListener?e.addEventListener=a:e.attachEvent&&(e.attachEvent=a)}($("#pac-input")[0])},itemsList=$("#locations-list"),showListButton=$("#show-list-button"),closeItemsList=function(){$(window).width()<=1024?itemsList.removeClass("visible"):(itemsList.removeClass("visible"),showListButton.find("i").html("keyboard_arrow_right"))},showItemsList=function(){itemsList.addClass("visible"),$(window).width()<=1024?showListButton.fadeOut():showListButton.find("i").html("keyboard_arrow_left")};$("#locations-filter").on("focus keydown",function(){showItemsList()}),$("#show-list-button").on("click",function(){"0px"===itemsList.css("left")?closeItemsList():showItemsList()}),$("#go-back-bar").on("click",function(){$("#locations-list").css("left","-100vw"),$("#show-list-button").fadeIn()}),$("#add-button").on("click",function(){$("#pac-input").val("")});