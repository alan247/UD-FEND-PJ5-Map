var viewModel=function(){function e(){var e=$("#pac-input").val();n.geocode({address:e},function(e,o){o==google.maps.GeocoderStatus.OK?(a.setCenter(e[0].geometry.location),cityName=e[0].formatted_address,cityLat=e[0].geometry.location.lat(),cityLong=e[0].geometry.location.lng(),new l(cityName,cityLat,cityLong,!0),t.storeLocally()):alert("Geocode was not successful for the following reason: "+o)})}var t=this;t.infoWindow=new google.maps.InfoWindow,t.wikiArticles=ko.observableArray(),t.flickrPics=ko.observableArray(),t.filter=ko.observable(""),t.currentCityCountry=ko.observable(),t.currentCity=ko.observable(),t.currentLocationData=ko.observable("Loading..."),t.currentOpenedMarker;var o=ko.observableArray([]),i=$("#info-window"),a=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(40.8333467,-48.1009912),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}}),n=new google.maps.Geocoder;new google.maps.places.Autocomplete(document.getElementById("pac-input"),{bounds:new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),types:["(cities)"]});t.storeLocally=function(){var e=o(),t=[];$.each(e,function(e,o){markerObject={name:o.name,lat:o.lat,"long":o["long"],userCreated:o.userCreated},t.push(markerObject)}),localStorage.setItem("userLocalData",JSON.stringify(t))},$("#pac-input").keyup(function(t){13==t.keyCode&&($("#add-overlay").hide(),e())});var l=function(e,i,n,l){o.push({marker:new google.maps.Marker({position:new google.maps.LatLng(i,n),title:e,animation:google.maps.Animation.DROP,map:a,icon:l?"http://maps.google.com/mapfiles/ms/micons/blue.png":"http://maps.google.com/mapfiles/ms/micons/red.png"}),name:e,lat:i,"long":n,userCreated:l});var r=o().length,s=o()[r-1],c=s.marker,d=s.name,m=s.lat,p=s["long"];c.addListener("click",function(){t.clickOnItem(d,c,m,p,l)})};if(t.deleteMarker=function(e){var i=e.name;for(var a in o())i===o()[a].name&&(o()[a].marker.setMap(null),o().splice(a,1),o(o()),t.storeLocally())},null!==localStorage.getItem("userLocalData")){var r=JSON.parse(localStorage.getItem("userLocalData"));$.each(r,function(e,t){var o=t.lat,i=t["long"],a=t.name,n=t.userCreated;new l(a,o,i,n)})}else{var s="http://paperbac.pairserver.com/locations.php";$.getJSON(s,function(e){var o=e.locations;$.each(o,function(e,t){var o=t.city+", "+t.country,i=t.latitude,a=t.longitude;new l(o,i,a,!1)}),t.infoWindow.setContent(i[0])}).fail(function(){console.log("fail ajax"),alert("Could not load sample markers from the server, but feel free to add your own!")})}t.clickOnItem=function(e,o,n,l,r){$("body").append(i),$(".list-container ul li").each(function(){var t=$(this).children(".list-item").html();e===t&&$(this).addClass("selected").siblings().removeClass("selected")}),t.closeInfoWindows();var s=e.split(",");t.currentCity(s[0]),t.currentCityCountry(e),t.currentLocationData(e+"|"+r),$(window).width()<=1024?($("#locations-list").delay(500).css("left","0"),$("#show-list-button").hide(),$("#info-window").show()):$("#infow-window").fadeIn(),$("#location-info").show();var c,d="http://maps.google.com/mapfiles/kml/paddle/blu-stars.png",m="http://maps.google.com/mapfiles/kml/paddle/red-stars.png";c=r?d:m,o.setIcon(c),o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},750);var p=new google.maps.LatLng(n,l);a.panTo(p),a.setZoom(5);var f=$(window).width();if($(window).width()<=1024)a.panBy(0,-210);else{var u=.5*f/2;a.panBy(-u,-210)}var g=n+"|"+l;t.getWikiData(g,o),t.getFlickrData(n,l,e),null!=$("#flickr-gallery").data("lightGallery")&&$("#flickr-gallery").data("lightGallery").destroy(!0)},t.goToMarker=function(e){var i=e.name;for(var a in o())if(i===o()[a].name){var n=o()[a].marker,l=o()[a].lat,r=o()[a]["long"],s=o()[a].userCreated;t.clickOnItem(i,n,l,r,s),setTimeout(function(){},750)}},t.clearMap=function(){t.filter("");var e=new google.maps.LatLng(40.8333467,-48.1009912);a.panTo(e),a.setZoom(2),t.closeInfoWindows(),$("#info-window").hide(),$("body").append(i)},t.closeInfoWindows=function(){var e=t.currentLocationData().split("|"),i=e[0],a=e[1];for(var n in o())if(i===o()[n].name){var l=o()[n].marker;"true"===a?l.setIcon("http://maps.google.com/mapfiles/ms/micons/blue.png"):l.setIcon("http://maps.google.com/mapfiles/ms/micons/red.png")}t.infoWindow.close()},google.maps.event.addListener(t.infoWindow,"closeclick",function(){t.clearMap()}),google.maps.event.addListener(a,"click",function(e){var o=t.infoWindow.getMap();null!==o&&"undefined"!=typeof o&&t.clearMap()}),t.filteredItems=ko.computed(function(){t.closeInfoWindows();var e=t.filter().toLowerCase();if(e)return ko.utils.arrayFilter(o(),function(t){for(var i in o()){var a=o()[i].name.toLowerCase();a.search(e)>=0?o()[i].marker.setVisible(!0):o()[i].marker.setVisible(!1)}return t.name.toLowerCase().search(e)>=0});for(var i=0;i<o().length;i++)o()[i].marker.setVisible(!0);return o()}),t.getWikiData=function(e,o){t.wikiArticles().length=0;var a="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages%7Cinfo&list=&generator=geosearch&piprop=thumbnail&pithumbsize=80&pilimit=4&inprop=url&ggscoord="+e+"&ggsradius=10000&ggslimit=4&callback=?";$.getJSON(a,function(e){var o=e.query.pages;$.each(o,function(e,o){var i=o.title,a=o.fullurl;if("thumbnail"in o)var n=o.thumbnail.source,l=o.thumbnail.width,r=o.thumbnail.height;else var n="http://thumbnail.image.rakuten.co.jp/@0_mall/com/css/c/pc/img/nopicture/nopicture.gif?_ex=128x128";var s={title:i,thumbnail:n,thumbnailWidth:l,thumbnailHeight:r,url:a};t.wikiArticles.push(s)}),t.infoWindow.setContent(i[0])}).fail(function(){$(".api-card.wikipedia").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach Wikipedia, try again later!</div>')})},t.getFlickrData=function(e,o,i){$("#flickr-gallery").hide(),$("#flickr-load").show(),t.flickrPics().length=0;var a=encodeURIComponent(i.split(",")[0].trim()),n="3a36e9a73746f67a89753089747aede3",l="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+n+"&format=json&nojsoncallback=1&per_page=10&tags="+a+",tourist&tag_mode=all";$.getJSON(l,function(e){var o=e.photos.photo;$.each(o,function(e,o){var i=o.farm,a=o.server,n=o.id,l=o.secret,r=(o.owner,o.title),s="http://farm"+i+".static.flickr.com/"+a+"/"+n+"_"+l+".jpg",c="http://farm"+i+".static.flickr.com/"+a+"/"+n+"_"+l+"_t.jpg",d={src:s,thumb:c,subHtml:r};t.flickrPics.push(d)})}).fail(function(){console.log("fail ajax"),$(".api-card.flickr").html('<div class="api-error"><i class="material-icons">error</i><br>Couldn\'t reach flickr, try again later!</div>')}).always(function(){$("#flickr-load").fadeOut(500),$("#flickr-gallery").delay(500).fadeIn(500),$("#flickr-gallery").lightGallery({}),$("#flickr-gallery").on("onCloseAfter.lg",function(e){})})},function(e){function t(t,i){if("keydown"==t){var a=i;i=function(t){var o=$(".pac-item-selected").length>0;if(13==t.which&&!o){var i=$.Event("keydown",{keyCode:40,which:40});a.apply(e,[i])}a.apply(e,[t])}}o.apply(e,[t,i])}var o=e.addEventListener?e.addEventListener:e.attachEvent;e.addEventListener?e.addEventListener=t:e.attachEvent&&(e.attachEvent=t)}($("#pac-input")[0])};ko.bindingHandlers.listClick={},ko.applyBindings(new viewModel);var itemsList=$("#locations-list"),showListButton=$("#show-list-button"),closeItemsList=function(){$(window).width()<=1024?itemsList.css("left","-100vw"):(itemsList.css("left","-25vw"),showListButton.find("i").html("keyboard_arrow_right"))},showItemsList=function(){itemsList.css("left","0"),$(window).width()<=1024?showListButton.fadeOut():showListButton.find("i").html("keyboard_arrow_left")};$("#locations-filter").on("focus keydown",function(){showItemsList()}),$("#show-list-button").on("click",function(){"0px"===itemsList.css("left")?closeItemsList():showItemsList()}),$("#go-back-bar").on("click",function(){$("#locations-list").css("left","-100vw"),$("#show-list-button").fadeIn()});var openAddItem=function(){$("#add-overlay").show(),$("#pac-input").val("").focus(),$("#overlay-close-button").on("click",function(){$(this).parent().hide()})};$("#add-button").on("click",function(){openAddItem()}),$(".delete-item").on("click",function(){console.log("delete item")}),$("#location-header i").on("click",function(){$("#location-info, #wikipedia-list").fadeOut()}),$(".action").on("click",function(){$("#wikipedia-list").fadeIn()}),$(".close-wikipedia i").on("click",function(){$("#wikipedia-list").fadeOut()});